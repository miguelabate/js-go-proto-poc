<!DOCTYPE html>
<html>

<head>
  <!-- closure lib from google -->
  <script src="libs-js/closure-library/closure/goog/base.js"></script>

  <!-- Protobuf -->
  <script src="libs-js/constants.js"></script>
  <script src="libs-js/utils.js"></script>
  <script src="libs-js/arith.js"></script>
  <script src="libs-js/decoder.js"></script>
  <script src="libs-js/encoder.js"></script>
  <script src="libs-js/reader.js"></script>
  <script src="libs-js/writer.js"></script>
  <script src="libs-js/map.js"></script>
  <script src="libs-js/message.js"></script>

  <!-- Generated from proto -->
  <script src="./build/gen/MyMessages.js"></script>
  <meta charset="utf-8">
  <script>
    window.addEventListener("load", function(evt) {
      var output = document.getElementById("output");
      var inputText = document.getElementById("inputText");
      var inputLang = document.getElementById("inputLang");
      var inputLength = document.getElementById("inputLength");
      var inputYears = document.getElementById("inputYears");
      var ws;
      var print = function(message) {
        var d = document.createElement("div");
        d.innerHTML = message;
        output.appendChild(d);
      };
      document.getElementById("open").onclick = function(evt) {
        if (ws) {
          return false;
        }
        ws = new WebSocket("ws://127.0.0.1:8081/echo");
        ws.onopen = function(evt) {
          print("OPEN");
        }
        ws.onclose = function(evt) {
          print("CLOSE");
          ws = null;
        }
        ws.onmessage = function(evt) {
          var blob = evt.data;
          var arrayBuffer;
          //  var subBlob = blob.slice(0, blob.size);
          var fr = new FileReader();
          fr.onload = function(e) {
            //console.log(new Float32Array(e.target.result)[0]);
            arrayBuffer = this.result;
            var byteArray = new Uint8Array(arrayBuffer);
            //  print("RESPONSE: " + evt.data);
            let message = proto.MessageMike.deserializeBinary(byteArray);
            console.log(message.toObject());
            inputYears.value = message.getYears();
            inputLength.value = message.getLength();
            inputLang.value = message.getLang();
            inputText.value = message.getText();
          };
          fr.readAsArrayBuffer(blob);

        }
        ws.onerror = function(evt) {
          print("ERROR: " + evt.data);
        }
        return false;
      };
      document.getElementById("send").onclick = function(evt) {
        if (!ws) {
          return false;
        }
        
        let message = new proto.MessageMike();
        message.setText(inputText.value);
        message.setLang(inputLang.value);
        message.setYears(inputYears.value);
        message.setLength(inputLength.value);
        print("SENT: " + message.toString());
        ws.send(message.serializeBinary());
        return false;
      };
      document.getElementById("close").onclick = function(evt) {
        if (!ws) {
          return false;
        }
        ws.close();
        return false;
      };
    });
  </script>
</head>

<body>
  <table>
    <tr>
      <td valign="top" width="50%">
        <p>"Open" to create a connection to the server<br>
          "Send" to send a message to the server<br>
	 "Close" to close the connection<br>
          You can change the message and send it. Then will receive an echo from the server with the message fields modified.
          <p>
            <form>
              <button id="open">Open</button>
              <button id="close">Close</button>
              <p>Text: <input id="inputText" type="text" value="text"></p>
              <p>Lang: <input id="inputLang" type="text" value="esp"></p>
              <p>Length: <input id="inputLength" type="text" value="23.56"></p>
              <p>Years: <input id="inputYears" type="text" value="14"></p>
              <button id="send">Send</button>
            </form>
      </td>
      <td valign="top" width="50%">
        <div id="output"></div>
      </td>
    </tr>
  </table>
</body>

</html>
